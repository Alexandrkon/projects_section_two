<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../../../../stylesheet.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span>package org.hl7.fhir.igtools.publisher.utils;<a name="line.1"></a>
<span class="sourceLineNo">002</span><a name="line.2"></a>
<span class="sourceLineNo">003</span>import java.io.File;<a name="line.3"></a>
<span class="sourceLineNo">004</span>import java.io.FileInputStream;<a name="line.4"></a>
<span class="sourceLineNo">005</span>import java.io.FileNotFoundException;<a name="line.5"></a>
<span class="sourceLineNo">006</span>import java.io.IOException;<a name="line.6"></a>
<span class="sourceLineNo">007</span>import java.io.InputStream;<a name="line.7"></a>
<span class="sourceLineNo">008</span>import java.text.SimpleDateFormat;<a name="line.8"></a>
<span class="sourceLineNo">009</span>import java.util.ArrayList;<a name="line.9"></a>
<span class="sourceLineNo">010</span>import java.util.Date;<a name="line.10"></a>
<span class="sourceLineNo">011</span>import java.util.List;<a name="line.11"></a>
<span class="sourceLineNo">012</span><a name="line.12"></a>
<span class="sourceLineNo">013</span>import org.apache.commons.io.FileUtils;<a name="line.13"></a>
<span class="sourceLineNo">014</span>import org.apache.commons.io.IOUtils;<a name="line.14"></a>
<span class="sourceLineNo">015</span>import org.hl7.fhir.igtools.publisher.PastProcessHackerUtilities;<a name="line.15"></a>
<span class="sourceLineNo">016</span>import org.hl7.fhir.igtools.publisher.Publisher;<a name="line.16"></a>
<span class="sourceLineNo">017</span>import org.hl7.fhir.utilities.IniFile;<a name="line.17"></a>
<span class="sourceLineNo">018</span>import org.hl7.fhir.utilities.Utilities;<a name="line.18"></a>
<span class="sourceLineNo">019</span>import org.hl7.fhir.utilities.ZipGenerator;<a name="line.19"></a>
<span class="sourceLineNo">020</span>import org.hl7.fhir.utilities.json.JSONUtil;<a name="line.20"></a>
<span class="sourceLineNo">021</span>import org.hl7.fhir.utilities.json.JsonTrackingParser;<a name="line.21"></a>
<span class="sourceLineNo">022</span>import org.hl7.fhir.utilities.npm.NpmPackage;<a name="line.22"></a>
<span class="sourceLineNo">023</span>import org.hl7.fhir.utilities.validation.ValidationMessage;<a name="line.23"></a>
<span class="sourceLineNo">024</span>import org.hl7.fhir.utilities.validation.ValidationMessage.IssueSeverity;<a name="line.24"></a>
<span class="sourceLineNo">025</span>import org.hl7.fhir.utilities.validation.ValidationMessage.IssueType;<a name="line.25"></a>
<span class="sourceLineNo">026</span>import org.hl7.fhir.utilities.validation.ValidationMessage.Source;<a name="line.26"></a>
<span class="sourceLineNo">027</span><a name="line.27"></a>
<span class="sourceLineNo">028</span>import com.google.gson.JsonArray;<a name="line.28"></a>
<span class="sourceLineNo">029</span>import com.google.gson.JsonObject;<a name="line.29"></a>
<span class="sourceLineNo">030</span><a name="line.30"></a>
<span class="sourceLineNo">031</span>import ca.uhn.fhir.util.JsonUtil;<a name="line.31"></a>
<span class="sourceLineNo">032</span><a name="line.32"></a>
<span class="sourceLineNo">033</span>public class PublicationProcess {<a name="line.33"></a>
<span class="sourceLineNo">034</span> <a name="line.34"></a>
<span class="sourceLineNo">035</span>  /*<a name="line.35"></a>
<span class="sourceLineNo">036</span>   * checks that must be run prior to runing this:<a name="line.36"></a>
<span class="sourceLineNo">037</span>   *  <a name="line.37"></a>
<span class="sourceLineNo">038</span>   *  - FMG has approved the publication<a name="line.38"></a>
<span class="sourceLineNo">039</span>   *  - FHIR Product Director has approved the version<a name="line.39"></a>
<span class="sourceLineNo">040</span>   *  - realm matches what was proposed and authorised.<a name="line.40"></a>
<span class="sourceLineNo">041</span>   *  - code hasn't been changed since last published and matches what was approved by FMG<a name="line.41"></a>
<span class="sourceLineNo">042</span>   *  - there are no publication issues outstanding<a name="line.42"></a>
<span class="sourceLineNo">043</span>   *  - remaining qa issues are ok<a name="line.43"></a>
<span class="sourceLineNo">044</span>   *  <a name="line.44"></a>
<span class="sourceLineNo">045</span>   * If this is a milestone:<a name="line.45"></a>
<span class="sourceLineNo">046</span>   *   - TSC has approved the publication<a name="line.46"></a>
<span class="sourceLineNo">047</span>   *   <a name="line.47"></a>
<span class="sourceLineNo">048</span>   */<a name="line.48"></a>
<span class="sourceLineNo">049</span>  <a name="line.49"></a>
<span class="sourceLineNo">050</span>  /**<a name="line.50"></a>
<span class="sourceLineNo">051</span>   * <a name="line.51"></a>
<span class="sourceLineNo">052</span>   * @param source - the directory that contains the IG source that will be published. This must be post normal build, and the build must have succeeded, and the output must have gone to \output. it will  be rebuilt<a name="line.52"></a>
<span class="sourceLineNo">053</span>   * @param destination - the root folder of the local copy of files for the web site to which the IG is being published. <a name="line.53"></a>
<span class="sourceLineNo">054</span>   * @throws Exception <a name="line.54"></a>
<span class="sourceLineNo">055</span>   */<a name="line.55"></a>
<span class="sourceLineNo">056</span>  public void publish(String source, String rootFolder, boolean milestone, String registrySource, String history, String temp) throws Exception {<a name="line.56"></a>
<span class="sourceLineNo">057</span>    PublisherConsoleLogger logger = new PublisherConsoleLogger();<a name="line.57"></a>
<span class="sourceLineNo">058</span>    logger.start(Utilities.path("[tmp]", "publication-process.log"));<a name="line.58"></a>
<span class="sourceLineNo">059</span>    try {<a name="line.59"></a>
<span class="sourceLineNo">060</span>      List&lt;ValidationMessage&gt; res = publishInner(source, rootFolder, milestone, registrySource, history, temp, logger);<a name="line.60"></a>
<span class="sourceLineNo">061</span>      if (res.size() == 0) {<a name="line.61"></a>
<span class="sourceLineNo">062</span>        System.out.println("Success");<a name="line.62"></a>
<span class="sourceLineNo">063</span>      } else {<a name="line.63"></a>
<span class="sourceLineNo">064</span>        for (ValidationMessage vm : res) {<a name="line.64"></a>
<span class="sourceLineNo">065</span>          System.out.println(vm.summary());<a name="line.65"></a>
<span class="sourceLineNo">066</span>        }<a name="line.66"></a>
<span class="sourceLineNo">067</span>      }<a name="line.67"></a>
<span class="sourceLineNo">068</span>    } catch (Exception e) {<a name="line.68"></a>
<span class="sourceLineNo">069</span>      System.out.println("Exception publishing: "+e.getMessage());<a name="line.69"></a>
<span class="sourceLineNo">070</span>      e.printStackTrace();<a name="line.70"></a>
<span class="sourceLineNo">071</span>    }<a name="line.71"></a>
<span class="sourceLineNo">072</span>    System.out.println("Full log in "+logger.getFilename());<a name="line.72"></a>
<span class="sourceLineNo">073</span>  }<a name="line.73"></a>
<span class="sourceLineNo">074</span>  <a name="line.74"></a>
<span class="sourceLineNo">075</span>  public List&lt;ValidationMessage&gt; publishInner(String source, String rootFolder, boolean milestone, String registrySource, String history, String temp, PublisherConsoleLogger logger) throws Exception {<a name="line.75"></a>
<span class="sourceLineNo">076</span>    List&lt;ValidationMessage&gt; res = new ArrayList&lt;&gt;();<a name="line.76"></a>
<span class="sourceLineNo">077</span><a name="line.77"></a>
<span class="sourceLineNo">078</span>    // check the wider context<a name="line.78"></a>
<span class="sourceLineNo">079</span>    File fSource = checkDirectory(source, res, "Source");<a name="line.79"></a>
<span class="sourceLineNo">080</span>    File fRoot = checkDirectory(rootFolder, res, "Destination");<a name="line.80"></a>
<span class="sourceLineNo">081</span>    checkDirectory(Utilities.path(rootFolder, "ig-build-zips"), res, "Destination Zip Folder");<a name="line.81"></a>
<span class="sourceLineNo">082</span>    File fRegistry = checkFile(registrySource, res, "Registry");<a name="line.82"></a>
<span class="sourceLineNo">083</span>    File fHistory = checkDirectory(history, res, "History Template");<a name="line.83"></a>
<span class="sourceLineNo">084</span>    File fPubIni = checkFile(Utilities.path(rootFolder, "publish.ini"), res, "Publish.ini");<a name="line.84"></a>
<span class="sourceLineNo">085</span>    if (res.size() &gt; 0) {<a name="line.85"></a>
<span class="sourceLineNo">086</span>      return res;<a name="line.86"></a>
<span class="sourceLineNo">087</span>    }<a name="line.87"></a>
<span class="sourceLineNo">088</span>    IniFile ini = new IniFile(fPubIni.getAbsolutePath());<a name="line.88"></a>
<span class="sourceLineNo">089</span>    String url = ini.getStringProperty("website", "url");<a name="line.89"></a>
<span class="sourceLineNo">090</span>    <a name="line.90"></a>
<span class="sourceLineNo">091</span>    // check the output<a name="line.91"></a>
<span class="sourceLineNo">092</span>    File fOutput = checkDirectory(Utilities.path(source, "output"), res, "Publication Source");<a name="line.92"></a>
<span class="sourceLineNo">093</span>    File fQA = checkFile(Utilities.path(source, "output", "qa.json"), res, "Publication QA info");<a name="line.93"></a>
<span class="sourceLineNo">094</span>    if (res.size() &gt; 0) {<a name="line.94"></a>
<span class="sourceLineNo">095</span>      return res;<a name="line.95"></a>
<span class="sourceLineNo">096</span>    }<a name="line.96"></a>
<span class="sourceLineNo">097</span>    JsonObject qa = JsonTrackingParser.parseJson(loadFile("Source QA file", fQA.getAbsolutePath()));<a name="line.97"></a>
<span class="sourceLineNo">098</span>    <a name="line.98"></a>
<span class="sourceLineNo">099</span>    // now: is the IG itself ready for publication<a name="line.99"></a>
<span class="sourceLineNo">100</span>    NpmPackage npm = NpmPackage.fromPackage(loadFile("Source package", Utilities.path(source, "output", "package.tgz")));<a name="line.100"></a>
<span class="sourceLineNo">101</span>    String id = npm.name();<a name="line.101"></a>
<span class="sourceLineNo">102</span>    String[] p = id.split("\\.");<a name="line.102"></a>
<span class="sourceLineNo">103</span>    boolean tho = false;<a name="line.103"></a>
<span class="sourceLineNo">104</span>    boolean cql = false;<a name="line.104"></a>
<span class="sourceLineNo">105</span>    String realm = null;<a name="line.105"></a>
<span class="sourceLineNo">106</span>    String code = null;<a name="line.106"></a>
<span class="sourceLineNo">107</span>    String canonical = PastProcessHackerUtilities.actualUrl(npm.canonical());<a name="line.107"></a>
<span class="sourceLineNo">108</span>    if (id.equals("hl7.terminology")) {<a name="line.108"></a>
<span class="sourceLineNo">109</span>      tho = true;<a name="line.109"></a>
<span class="sourceLineNo">110</span>      if (!check(res, npm.canonical().equals("http://terminology.hl7.org") &amp;&amp; url.equals("http://terminology.hl7.org"), "Proposed canonical '"+npm.canonical()+"' does not match the web site URL '"+url+"' with a value of http://terminology.hl7.org")) {<a name="line.110"></a>
<span class="sourceLineNo">111</span>        return res;<a name="line.111"></a>
<span class="sourceLineNo">112</span>      }      <a name="line.112"></a>
<span class="sourceLineNo">113</span>    } else if (id.equals("hl7.cql")) {<a name="line.113"></a>
<span class="sourceLineNo">114</span>      cql = true;<a name="line.114"></a>
<span class="sourceLineNo">115</span>      if (!check(res, npm.canonical().equals("http://cql.hl7.org") &amp;&amp; url.equals("http://cql.hl7.org"), "Proposed canonical '"+npm.canonical()+"' does not match the web site URL '"+url+"' with a value of http://cql.hl7.org")) {<a name="line.115"></a>
<span class="sourceLineNo">116</span>        return res;<a name="line.116"></a>
<span class="sourceLineNo">117</span>      }      <a name="line.117"></a>
<span class="sourceLineNo">118</span>      <a name="line.118"></a>
<span class="sourceLineNo">119</span>    } else {<a name="line.119"></a>
<span class="sourceLineNo">120</span>      if (!check(res, p.length == 4 &amp;&amp; "hl7".equals(p[0]) &amp;&amp; "fhir".equals(p[1]), "Package Id '"+id+"' is not valid:  must have 4 parts (hl7.fhir.[realm].[code]")) {<a name="line.120"></a>
<span class="sourceLineNo">121</span>        return res;<a name="line.121"></a>
<span class="sourceLineNo">122</span>      }<a name="line.122"></a>
<span class="sourceLineNo">123</span>      realm = p[2];<a name="line.123"></a>
<span class="sourceLineNo">124</span>      code = p[3];<a name="line.124"></a>
<span class="sourceLineNo">125</span>      if (!check(res, canonical != null &amp;&amp; (canonical.equals("http://hl7.org/fhir/"+realm+"/"+code)  || canonical.equals("http://hl7.org/fhir/smart-app-launch")), "canonical URL of "+canonical+" does not match the required canonical of http://hl7.org/fhir/"+realm+"/"+code)) {<a name="line.125"></a>
<span class="sourceLineNo">126</span>        return res;<a name="line.126"></a>
<span class="sourceLineNo">127</span>      }<a name="line.127"></a>
<span class="sourceLineNo">128</span>      if (!check(res, canonical.startsWith(url), "Proposed canonical '"+canonical+"' does not match the web site URL '"+url+"'")) {<a name="line.128"></a>
<span class="sourceLineNo">129</span>        return res;<a name="line.129"></a>
<span class="sourceLineNo">130</span>      }<a name="line.130"></a>
<span class="sourceLineNo">131</span>    }<a name="line.131"></a>
<span class="sourceLineNo">132</span><a name="line.132"></a>
<span class="sourceLineNo">133</span>    String version = npm.version();<a name="line.133"></a>
<span class="sourceLineNo">134</span>    if (!check(res, version != null, "Source Package has no version")) {<a name="line.134"></a>
<span class="sourceLineNo">135</span>      return res;<a name="line.135"></a>
<span class="sourceLineNo">136</span>    }<a name="line.136"></a>
<span class="sourceLineNo">137</span>    <a name="line.137"></a>
<span class="sourceLineNo">138</span>    String destination = tho || cql ? rootFolder : PastProcessHackerUtilities.useRealm(realm, code) ? Utilities.path(rootFolder, realm, code) :  Utilities.path(rootFolder, code);<a name="line.138"></a>
<span class="sourceLineNo">139</span>    if (!check(res, new File(Utilities.path(destination, "package-list.json")).exists(), "Destination '"+destination+"' does not contain a package-list.json - must be set up manually for first publication")) {<a name="line.139"></a>
<span class="sourceLineNo">140</span>      return res;<a name="line.140"></a>
<span class="sourceLineNo">141</span>    }<a name="line.141"></a>
<span class="sourceLineNo">142</span>    if (!check(res, new File(Utilities.path(source, "package-list.json")).exists(), "Source '"+source+"' does not contain a package-list.json - consult documentation to see how to set it up")) {<a name="line.142"></a>
<span class="sourceLineNo">143</span>      return res;<a name="line.143"></a>
<span class="sourceLineNo">144</span>    }            <a name="line.144"></a>
<span class="sourceLineNo">145</span>    <a name="line.145"></a>
<span class="sourceLineNo">146</span>    JsonObject plSrc = JsonTrackingParser.parseJson(loadFile("Source Package List", Utilities.path(source, "package-list.json")));<a name="line.146"></a>
<span class="sourceLineNo">147</span>    JsonObject plPub = JsonTrackingParser.parseJson(loadFile("Published Package List", Utilities.path(destination, "package-list.json")));<a name="line.147"></a>
<span class="sourceLineNo">148</span><a name="line.148"></a>
<span class="sourceLineNo">149</span>    check(res, id.equals(JSONUtil.str(plSrc, "package-id")), "Source Package List has the wrong package id: "+JSONUtil.str(plSrc, "package-id")+" (should be "+id+")");<a name="line.149"></a>
<span class="sourceLineNo">150</span>    check(res, id.equals(JSONUtil.str(plPub, "package-id")), "Published Package List has the wrong package id: "+JSONUtil.str(plPub, "package-id")+" (should be "+id+")");<a name="line.150"></a>
<span class="sourceLineNo">151</span>    check(res, canonical.equals(JSONUtil.str(plSrc, "canonical")), "Source Package List has the wrong canonical: "+JSONUtil.str(plSrc, "canonical")+" (should be "+canonical+")");<a name="line.151"></a>
<span class="sourceLineNo">152</span>    check(res, canonical.equals(JSONUtil.str(plPub, "canonical")), "Source Package List has the wrong canonical: "+JSONUtil.str(plPub, "canonical")+" (should be "+canonical+")");<a name="line.152"></a>
<span class="sourceLineNo">153</span>    check(res, plSrc.has("category"), "No Entry found in source package-list for 'category'");<a name="line.153"></a>
<span class="sourceLineNo">154</span>    check(res, plPub.has("category"), "No Entry found in dest package-list 'category'");<a name="line.154"></a>
<span class="sourceLineNo">155</span>    check(res, JSONUtil.str(plSrc, "category").equals(JSONUtil.str(plPub, "category")), "Category values differ between source and publication package-list: "+JSONUtil.str(plSrc, "category")+" vs " +JSONUtil.str(plPub, "category"));<a name="line.155"></a>
<span class="sourceLineNo">156</span><a name="line.156"></a>
<span class="sourceLineNo">157</span>    JsonObject vSrc = JSONUtil.findByStringProp(plSrc.getAsJsonArray("list"), "version", version);<a name="line.157"></a>
<span class="sourceLineNo">158</span>    JsonObject vPub = JSONUtil.findByStringProp(plPub.getAsJsonArray("list"), "version", version);<a name="line.158"></a>
<span class="sourceLineNo">159</span>    <a name="line.159"></a>
<span class="sourceLineNo">160</span>    check(res, plPub.getAsJsonArray("list").size() &gt; 0, "Dest package-list has no existent version (should have ci-build entry)");<a name="line.160"></a>
<span class="sourceLineNo">161</span>    check(res, vSrc != null, "No Entry found in source package-list for v"+version);<a name="line.161"></a>
<span class="sourceLineNo">162</span>    check(res, vPub == null, "Found an entry in the publication package-list for v"+version+" - it looks like it has already been published");<a name="line.162"></a>
<span class="sourceLineNo">163</span>    if (vSrc == null) { <a name="line.163"></a>
<span class="sourceLineNo">164</span>      return res;<a name="line.164"></a>
<span class="sourceLineNo">165</span>    }<a name="line.165"></a>
<span class="sourceLineNo">166</span>    check(res, vSrc.has("desc") || vSrc.has("descmd"), "Source Package list has no description for v"+version);<a name="line.166"></a>
<span class="sourceLineNo">167</span>    String pathVer = JSONUtil.str(vSrc, "path");<a name="line.167"></a>
<span class="sourceLineNo">168</span>    String vCode = pathVer.substring(pathVer.lastIndexOf("/")+1);<a name="line.168"></a>
<span class="sourceLineNo">169</span>    <a name="line.169"></a>
<span class="sourceLineNo">170</span>    check(res, pathVer.equals(Utilities.pathURL(canonical, vCode)), "Source Package list path v"+version+" is wrong - is '"+JSONUtil.str(vSrc, "path")+"', doesn't match canonical)");<a name="line.170"></a>
<span class="sourceLineNo">171</span>    check(res, npm.fhirVersion().equals(JSONUtil.str(vSrc, "fhirversion")), "Source Package list fhir version for v"+version+" is wrong - is '"+JSONUtil.str(vSrc, "fhirversion")+"', should be '"+npm.fhirVersion()+"')");<a name="line.171"></a>
<span class="sourceLineNo">172</span>    // ok, the ids and canonicals are all lined up, and w're ready to publish     <a name="line.172"></a>
<span class="sourceLineNo">173</span><a name="line.173"></a>
<span class="sourceLineNo">174</span>    check(res, id.equals(JSONUtil.str(qa, "package-id")), "Generated IG has wrong package "+JSONUtil.str(qa, "package-id"));<a name="line.174"></a>
<span class="sourceLineNo">175</span>    check(res, version.equals(JSONUtil.str(qa, "ig-ver")), "Generated IG has wrong version "+JSONUtil.str(qa, "ig-ver"));<a name="line.175"></a>
<span class="sourceLineNo">176</span>    check(res, qa.has("errs"), "Generated IG has no error count");<a name="line.176"></a>
<span class="sourceLineNo">177</span>    check(res, npm.fhirVersion().equals(JSONUtil.str(qa, "version")), "Generated IG has wrong FHIR version "+JSONUtil.str(qa, "version"));<a name="line.177"></a>
<span class="sourceLineNo">178</span>    check(res, JSONUtil.str(qa, "url").startsWith(canonical) || JSONUtil.str(qa, "url").startsWith(npm.canonical()), "Generated IG has wrong Canonical "+JSONUtil.str(qa, "url"));<a name="line.178"></a>
<span class="sourceLineNo">179</span>    <a name="line.179"></a>
<span class="sourceLineNo">180</span>    String destVer = Utilities.path(destination, vCode);<a name="line.180"></a>
<span class="sourceLineNo">181</span>    if (!check(res, new File(destination).exists(), "Destination '"+destVer+"' not found - must be set up manually for first publication")) {<a name="line.181"></a>
<span class="sourceLineNo">182</span>      return res;<a name="line.182"></a>
<span class="sourceLineNo">183</span>    }    <a name="line.183"></a>
<span class="sourceLineNo">184</span>    check(res, !(new File(destVer).exists()), "Nominated path '"+destVer+"' already exists");<a name="line.184"></a>
<span class="sourceLineNo">185</span><a name="line.185"></a>
<span class="sourceLineNo">186</span>    // todo: check the license, header, footer?... <a name="line.186"></a>
<span class="sourceLineNo">187</span>    <a name="line.187"></a>
<span class="sourceLineNo">188</span>    // well, we've run out of things to test... time to actually try...<a name="line.188"></a>
<span class="sourceLineNo">189</span>    if (res.size() == 0) {<a name="line.189"></a>
<span class="sourceLineNo">190</span>      doPublish(fSource, fOutput, qa, destination, destVer, pathVer, fRoot, ini, plPub, vSrc, fRegistry, npm, milestone, fHistory, temp, logger);<a name="line.190"></a>
<span class="sourceLineNo">191</span>    }        <a name="line.191"></a>
<span class="sourceLineNo">192</span>    return res;<a name="line.192"></a>
<span class="sourceLineNo">193</span>    <a name="line.193"></a>
<span class="sourceLineNo">194</span>  }<a name="line.194"></a>
<span class="sourceLineNo">195</span><a name="line.195"></a>
<span class="sourceLineNo">196</span>  private File checkDirectory(String filename, List&lt;ValidationMessage&gt; res, String name) throws Exception {<a name="line.196"></a>
<span class="sourceLineNo">197</span>    if (filename == null) {<a name="line.197"></a>
<span class="sourceLineNo">198</span>      throw new Exception("No "+name+" parameter provided");<a name="line.198"></a>
<span class="sourceLineNo">199</span>    }<a name="line.199"></a>
<span class="sourceLineNo">200</span>    File f = new File(filename);<a name="line.200"></a>
<span class="sourceLineNo">201</span>    if (check(res, f.exists(), name+" '"+filename+"' not found")) {<a name="line.201"></a>
<span class="sourceLineNo">202</span>      check(res, f.isDirectory(), name+" '"+filename+"' is not a directory");<a name="line.202"></a>
<span class="sourceLineNo">203</span>    }    <a name="line.203"></a>
<span class="sourceLineNo">204</span>    return f;<a name="line.204"></a>
<span class="sourceLineNo">205</span>  }<a name="line.205"></a>
<span class="sourceLineNo">206</span><a name="line.206"></a>
<span class="sourceLineNo">207</span>  private File checkFile(String filename, List&lt;ValidationMessage&gt; res, String name) {<a name="line.207"></a>
<span class="sourceLineNo">208</span>    File f = new File(filename);<a name="line.208"></a>
<span class="sourceLineNo">209</span>    if (check(res, f.exists(), name+" '"+filename+"' not found")) {<a name="line.209"></a>
<span class="sourceLineNo">210</span>      check(res, !f.isDirectory(), name+" '"+filename+"' is a directory");<a name="line.210"></a>
<span class="sourceLineNo">211</span>    }    <a name="line.211"></a>
<span class="sourceLineNo">212</span>    return f;<a name="line.212"></a>
<span class="sourceLineNo">213</span>  }<a name="line.213"></a>
<span class="sourceLineNo">214</span><a name="line.214"></a>
<span class="sourceLineNo">215</span>  private boolean check(List&lt;ValidationMessage&gt; res, boolean b, String message) {<a name="line.215"></a>
<span class="sourceLineNo">216</span>    if (!b)  {<a name="line.216"></a>
<span class="sourceLineNo">217</span>      ValidationMessage msg = new ValidationMessage(Source.Publisher, IssueType.EXCEPTION, "parameters", message, IssueSeverity.ERROR);<a name="line.217"></a>
<span class="sourceLineNo">218</span>      res.add(msg);<a name="line.218"></a>
<span class="sourceLineNo">219</span>    }<a name="line.219"></a>
<span class="sourceLineNo">220</span>    return b;<a name="line.220"></a>
<span class="sourceLineNo">221</span>    <a name="line.221"></a>
<span class="sourceLineNo">222</span>  }<a name="line.222"></a>
<span class="sourceLineNo">223</span><a name="line.223"></a>
<span class="sourceLineNo">224</span>  private InputStream loadFile(String string, String path) throws FileNotFoundException {<a name="line.224"></a>
<span class="sourceLineNo">225</span>    File f = new File(path);<a name="line.225"></a>
<span class="sourceLineNo">226</span>    if (!f.exists()) {<a name="line.226"></a>
<span class="sourceLineNo">227</span>      throw new Error("File "+string+" at "+path+" not found");<a name="line.227"></a>
<span class="sourceLineNo">228</span>    }<a name="line.228"></a>
<span class="sourceLineNo">229</span>    return new FileInputStream(f);<a name="line.229"></a>
<span class="sourceLineNo">230</span>  }<a name="line.230"></a>
<span class="sourceLineNo">231</span><a name="line.231"></a>
<span class="sourceLineNo">232</span>  private void doPublish(File fSource, File fOutput, JsonObject qa, String destination, String destVer, String pathVer, File fRoot, IniFile ini, JsonObject plPub, JsonObject vSrc, File fRegistry, NpmPackage npm, boolean milestone, File history, String tempDir, PublisherConsoleLogger logger) throws Exception {<a name="line.232"></a>
<span class="sourceLineNo">233</span>    // ok. all our tests have passed.<a name="line.233"></a>
<span class="sourceLineNo">234</span>    // 1. do the publication build(s)<a name="line.234"></a>
<span class="sourceLineNo">235</span>    System.out.println("All checks passed. Do the publication builds");        <a name="line.235"></a>
<span class="sourceLineNo">236</span><a name="line.236"></a>
<span class="sourceLineNo">237</span>    // create a temporary copy and build in that:<a name="line.237"></a>
<span class="sourceLineNo">238</span>    File temp = cloneToTemp(tempDir, fSource, npm.name()+"#"+npm.version());<a name="line.238"></a>
<span class="sourceLineNo">239</span>    File tempM = null; <a name="line.239"></a>
<span class="sourceLineNo">240</span>    System.out.println("Build IG at "+fSource.getAbsolutePath()+": final copy suitable for publication (in "+temp.getAbsolutePath()+")");        <a name="line.240"></a>
<span class="sourceLineNo">241</span>    runBuild(qa, temp.getAbsolutePath(), new String[] {"-ig", temp.getAbsolutePath(), "-resetTx", "-publish", pathVer, "-no-exit"});<a name="line.241"></a>
<span class="sourceLineNo">242</span><a name="line.242"></a>
<span class="sourceLineNo">243</span>    if (milestone) {<a name="line.243"></a>
<span class="sourceLineNo">244</span>      tempM = cloneToTemp(tempDir, temp, npm.name()+"#"+npm.version()+"-milestone");<a name="line.244"></a>
<span class="sourceLineNo">245</span>      System.out.println("Build IG at "+fSource.getAbsolutePath()+": final copy suitable for publication (in "+tempM.getAbsolutePath()+") (milestone build)");        <a name="line.245"></a>
<span class="sourceLineNo">246</span>      runBuild(qa, tempM.getAbsolutePath(), new String[] {"-ig", tempM.getAbsolutePath(), "-publish", pathVer, "-milestone", "-no-exit"});      <a name="line.246"></a>
<span class="sourceLineNo">247</span>    }<a name="line.247"></a>
<span class="sourceLineNo">248</span><a name="line.248"></a>
<span class="sourceLineNo">249</span>    // 2. make a copy of what we built<a name="line.249"></a>
<span class="sourceLineNo">250</span>    System.out.println("Keep a copy of the build directory at "+Utilities.path(fRoot.getAbsolutePath(), "ig-build-zips", npm.name()+"#"+npm.version()+".zip"));    <a name="line.250"></a>
<span class="sourceLineNo">251</span>    zipFolder(temp, Utilities.path(fRoot.getAbsolutePath(), "ig-build-zips", npm.name()+"#"+npm.version()+".zip"));<a name="line.251"></a>
<span class="sourceLineNo">252</span><a name="line.252"></a>
<span class="sourceLineNo">253</span>    System.out.println("");        <a name="line.253"></a>
<span class="sourceLineNo">254</span>    System.out.println("ok. All checks passed. Publish v"+npm.version()+" to "+destVer);        <a name="line.254"></a>
<span class="sourceLineNo">255</span><a name="line.255"></a>
<span class="sourceLineNo">256</span>    // check to see if there's a history; if there isn't, copy it in<a name="line.256"></a>
<span class="sourceLineNo">257</span>    if (!new File(Utilities.path(destination, "history.html")).exists()) {<a name="line.257"></a>
<span class="sourceLineNo">258</span>      System.out.println("Copy history from "+history.getAbsolutePath()+" to "+destination);    <a name="line.258"></a>
<span class="sourceLineNo">259</span>      Utilities.copyDirectory(history.getAbsolutePath(), destination, null);<a name="line.259"></a>
<span class="sourceLineNo">260</span>    }<a name="line.260"></a>
<span class="sourceLineNo">261</span><a name="line.261"></a>
<span class="sourceLineNo">262</span>    // 3. create the folder {root}/{realm}/{code}/{subdir}<a name="line.262"></a>
<span class="sourceLineNo">263</span>    System.out.println("Copy the IG to "+destVer);    <a name="line.263"></a>
<span class="sourceLineNo">264</span>    Utilities.createDirectory(destVer);<a name="line.264"></a>
<span class="sourceLineNo">265</span>    FileUtils.copyDirectory(new File(Utilities.path(temp.getAbsolutePath(), "output")), new File(destVer));<a name="line.265"></a>
<span class="sourceLineNo">266</span><a name="line.266"></a>
<span class="sourceLineNo">267</span>    // now, update the package list <a name="line.267"></a>
<span class="sourceLineNo">268</span>    System.out.println("Update "+Utilities.path(destination, "package-list.json"));    <a name="line.268"></a>
<span class="sourceLineNo">269</span>    updatePackageList(plPub, vSrc, Utilities.path(destination, "package-list.json"), milestone);<a name="line.269"></a>
<span class="sourceLineNo">270</span>    <a name="line.270"></a>
<span class="sourceLineNo">271</span>    if (milestone) {<a name="line.271"></a>
<span class="sourceLineNo">272</span>      System.out.println("This is a milestone release - publish v"+npm.version()+" to "+destination);      <a name="line.272"></a>
<span class="sourceLineNo">273</span>      <a name="line.273"></a>
<span class="sourceLineNo">274</span>      System.out.println("Clear out existing content");        <a name="line.274"></a>
<span class="sourceLineNo">275</span>      Publisher.main(new String[] { "-delete-current", destination, "-history", history.getAbsolutePath(), "-no-exit"});       <a name="line.275"></a>
<span class="sourceLineNo">276</span><a name="line.276"></a>
<span class="sourceLineNo">277</span>      System.out.println("Copy to directory");        <a name="line.277"></a>
<span class="sourceLineNo">278</span>      FileUtils.copyDirectory(new File(Utilities.path(tempM.getAbsolutePath(), "output")), new File(destination));<a name="line.278"></a>
<span class="sourceLineNo">279</span>    }<a name="line.279"></a>
<span class="sourceLineNo">280</span>    <a name="line.280"></a>
<span class="sourceLineNo">281</span>    // finally<a name="line.281"></a>
<span class="sourceLineNo">282</span>    System.out.println("Rebuild everything for "+Utilities.path(destination, "package-list.json"));<a name="line.282"></a>
<span class="sourceLineNo">283</span>    Publisher.main(new String[] { "-publish-update", "-folder", fRoot.getAbsolutePath(), "-registry", fRegistry.getAbsolutePath(), "-filter", destination, "-no-exit"});<a name="line.283"></a>
<span class="sourceLineNo">284</span><a name="line.284"></a>
<span class="sourceLineNo">285</span>    System.out.println("Finished Publishing");<a name="line.285"></a>
<span class="sourceLineNo">286</span>    logger.stop();<a name="line.286"></a>
<span class="sourceLineNo">287</span>    FileUtils.copyFile(new File(logger.getFilename()), new File(Utilities.path(fRoot.getAbsolutePath(), "ig-build-zips", npm.name()+"#"+npm.version()+".log")));    <a name="line.287"></a>
<span class="sourceLineNo">288</span>  }<a name="line.288"></a>
<span class="sourceLineNo">289</span><a name="line.289"></a>
<span class="sourceLineNo">290</span>  private File cloneToTemp(String tempDir, File fSource, String name) throws IOException {<a name="line.290"></a>
<span class="sourceLineNo">291</span>    if (tempDir == null) {<a name="line.291"></a>
<span class="sourceLineNo">292</span>      tempDir = "[tmp]";<a name="line.292"></a>
<span class="sourceLineNo">293</span>    }<a name="line.293"></a>
<span class="sourceLineNo">294</span>    String dest = Utilities.path(tempDir, name);<a name="line.294"></a>
<span class="sourceLineNo">295</span>    System.out.println("Prepare Build space in "+dest);        <a name="line.295"></a>
<span class="sourceLineNo">296</span>    File fDest = new File(dest);<a name="line.296"></a>
<span class="sourceLineNo">297</span>    if (!fDest.exists()) {<a name="line.297"></a>
<span class="sourceLineNo">298</span>      Utilities.createDirectory(dest);<a name="line.298"></a>
<span class="sourceLineNo">299</span>    } else {<a name="line.299"></a>
<span class="sourceLineNo">300</span>      Utilities.clearDirectory(dest);<a name="line.300"></a>
<span class="sourceLineNo">301</span>    }<a name="line.301"></a>
<span class="sourceLineNo">302</span>    FileUtils.copyDirectory(fSource, fDest);<a name="line.302"></a>
<span class="sourceLineNo">303</span>    return fDest;<a name="line.303"></a>
<span class="sourceLineNo">304</span>  }<a name="line.304"></a>
<span class="sourceLineNo">305</span>  <a name="line.305"></a>
<span class="sourceLineNo">306</span>  private void updatePackageList(JsonObject plPub, JsonObject vSrc, String path, boolean milestone) throws IOException {<a name="line.306"></a>
<span class="sourceLineNo">307</span>    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");<a name="line.307"></a>
<span class="sourceLineNo">308</span>    String date = sdf.format(new Date());<a name="line.308"></a>
<span class="sourceLineNo">309</span>    if (vSrc.has("date")) {<a name="line.309"></a>
<span class="sourceLineNo">310</span>      vSrc.remove("date");<a name="line.310"></a>
<span class="sourceLineNo">311</span>    }<a name="line.311"></a>
<span class="sourceLineNo">312</span>    vSrc.addProperty("date", date);<a name="line.312"></a>
<span class="sourceLineNo">313</span>    if (vSrc.has("current")) {<a name="line.313"></a>
<span class="sourceLineNo">314</span>      vSrc.remove("current");      <a name="line.314"></a>
<span class="sourceLineNo">315</span>    }<a name="line.315"></a>
<span class="sourceLineNo">316</span>    if (milestone) {<a name="line.316"></a>
<span class="sourceLineNo">317</span>      vSrc.addProperty("current", true);<a name="line.317"></a>
<span class="sourceLineNo">318</span>    }<a name="line.318"></a>
<span class="sourceLineNo">319</span>    JsonArray oldArr = plPub.getAsJsonArray("list");<a name="line.319"></a>
<span class="sourceLineNo">320</span>    JsonArray newArr = new JsonArray();<a name="line.320"></a>
<span class="sourceLineNo">321</span>    newArr.add(oldArr.get(0)); // the ci-build entry<a name="line.321"></a>
<span class="sourceLineNo">322</span>    newArr.add(vSrc);<a name="line.322"></a>
<span class="sourceLineNo">323</span>    for (int i = 1; i &lt; oldArr.size(); i++) {<a name="line.323"></a>
<span class="sourceLineNo">324</span>      JsonObject v = (JsonObject) oldArr.get(i);<a name="line.324"></a>
<span class="sourceLineNo">325</span>      if (milestone &amp;&amp; v.has("current")) {<a name="line.325"></a>
<span class="sourceLineNo">326</span>        v.remove("current");      <a name="line.326"></a>
<span class="sourceLineNo">327</span>      }<a name="line.327"></a>
<span class="sourceLineNo">328</span>      newArr.add(v);<a name="line.328"></a>
<span class="sourceLineNo">329</span>    }<a name="line.329"></a>
<span class="sourceLineNo">330</span>    plPub.remove("list");<a name="line.330"></a>
<span class="sourceLineNo">331</span>    plPub.add("list", newArr);<a name="line.331"></a>
<span class="sourceLineNo">332</span>    JsonTrackingParser.write(plPub, new File(path));<a name="line.332"></a>
<span class="sourceLineNo">333</span>  }<a name="line.333"></a>
<span class="sourceLineNo">334</span><a name="line.334"></a>
<span class="sourceLineNo">335</span>  private void zipFolder(File fSource, String path) throws IOException {<a name="line.335"></a>
<span class="sourceLineNo">336</span>    ZipGenerator zip = new ZipGenerator(path);<a name="line.336"></a>
<span class="sourceLineNo">337</span>    zip.addFolder(fSource.getAbsolutePath(), "", false);<a name="line.337"></a>
<span class="sourceLineNo">338</span>    zip.close();<a name="line.338"></a>
<span class="sourceLineNo">339</span>  }<a name="line.339"></a>
<span class="sourceLineNo">340</span><a name="line.340"></a>
<span class="sourceLineNo">341</span>  private void runBuild(JsonObject qa, String path, String[] args) throws Exception {<a name="line.341"></a>
<span class="sourceLineNo">342</span>    Publisher.main(args); // any exceptions, we just let them propagate<a name="line.342"></a>
<span class="sourceLineNo">343</span>    // check it built ok:<a name="line.343"></a>
<span class="sourceLineNo">344</span>    File f = new File(Utilities.path(path, "output", "qa.json"));<a name="line.344"></a>
<span class="sourceLineNo">345</span>    if (!f.exists()) {<a name="line.345"></a>
<span class="sourceLineNo">346</span>      throw new Error("File "+f.getAbsolutePath()+" not found - it appears the build run failed");<a name="line.346"></a>
<span class="sourceLineNo">347</span>    }<a name="line.347"></a>
<span class="sourceLineNo">348</span>    JsonObject nqa = JsonTrackingParser.parseJson(loadFile("Source QA file", f.getAbsolutePath()));<a name="line.348"></a>
<span class="sourceLineNo">349</span>    compareJsonProp(qa, nqa, "errs", "Errors");<a name="line.349"></a>
<span class="sourceLineNo">350</span>    compareJsonProp(qa, nqa, "warnings", "Warnings");<a name="line.350"></a>
<span class="sourceLineNo">351</span>    compareJsonProp(qa, nqa, "hints", "Hints");<a name="line.351"></a>
<span class="sourceLineNo">352</span>  }<a name="line.352"></a>
<span class="sourceLineNo">353</span><a name="line.353"></a>
<span class="sourceLineNo">354</span>  private void compareJsonProp(JsonObject qa, JsonObject nqa, String name, String label) throws Exception {<a name="line.354"></a>
<span class="sourceLineNo">355</span>    if (!qa.has(name)) {<a name="line.355"></a>
<span class="sourceLineNo">356</span>      throw new Exception("Unable to find "+name+" for past run");<a name="line.356"></a>
<span class="sourceLineNo">357</span>    }<a name="line.357"></a>
<span class="sourceLineNo">358</span>    int oldv = qa.get(name).getAsInt();<a name="line.358"></a>
<span class="sourceLineNo">359</span>    if (!nqa.has(name)) {<a name="line.359"></a>
<span class="sourceLineNo">360</span>      throw new Exception("Unable to find "+name+" for current run");<a name="line.360"></a>
<span class="sourceLineNo">361</span>    }<a name="line.361"></a>
<span class="sourceLineNo">362</span>    int newv = qa.get(name).getAsInt();<a name="line.362"></a>
<span class="sourceLineNo">363</span>    if (newv &gt; oldv) {<a name="line.363"></a>
<span class="sourceLineNo">364</span>      throw new Exception("Increase in "+label+" on run - was "+oldv+", now "+newv);      <a name="line.364"></a>
<span class="sourceLineNo">365</span>    }<a name="line.365"></a>
<span class="sourceLineNo">366</span>  }<a name="line.366"></a>
<span class="sourceLineNo">367</span><a name="line.367"></a>
<span class="sourceLineNo">368</span><a name="line.368"></a>
<span class="sourceLineNo">369</span>}<a name="line.369"></a>




























































</pre>
</div>
</body>
</html>
